// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // Runtime URL (Prisma Client). For Prisma Accelerate, this must start with:
  // - prisma://  OR  prisma+postgres://
  url      = env("PRISMA_DATABASE_URL")

  // Direct Postgres URL used by Prisma tools (migrate/introspect).
  // Your existing snippet uses DATABASE_URL for this direct connection.
  directUrl = env("DATABASE_URL")
}

enum AuthProvider {
  google
  github
  discord
  telegram

  @@map("auth_provider")
}

enum ScheduleType {
  daily
  weekly
  cron

  @@map("schedule_type")
}

enum ChannelType {
  discord
  telegram
  webhook

  @@map("channel_type")
}

enum RunStatus {
  running
  success
  fail

  @@map("run_status")
}

model User {
  id             String       @id @default(uuid()) @db.Uuid
  provider       AuthProvider
  providerUserId String       @map("provider_user_id")
  email          String?
  name           String?
  avatarUrl      String?      @map("avatar_url")
  createdAt      DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  jobs           Job[]
  previewEvents  PreviewEvent[]
  auditLogs      AuditLog[]

  @@unique([provider, providerUserId])
  @@map("users")
}

model AuditLog {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  action     String
  entityType String   @map("entity_type")
  entityId   String?  @map("entity_id")
  data       Json?
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt], map: "idx_audit_logs_user_id_created_at")
  @@index([entityType, entityId], map: "idx_audit_logs_entity")
  @@map("audit_logs")
}

model Job {
  id                String       @id @default(uuid()) @db.Uuid
  userId            String       @map("user_id") @db.Uuid
  name              String
  prompt            String
  publishedPromptVersionId String? @map("published_prompt_version_id") @db.Uuid
  allowWebSearch    Boolean      @default(false) @map("allow_web_search")
  llmModel          String?      @map("llm_model")
  webSearchMode     String?      @map("web_search_mode")
  scheduleType      ScheduleType @map("schedule_type")
  scheduleTime      String       @map("schedule_time")
  scheduleDayOfWeek Int?         @map("schedule_day_of_week")
  scheduleCron      String?      @map("schedule_cron")
  channelType       ChannelType  @map("channel_type")
  channelConfig     Json         @map("channel_config")
  enabled           Boolean      @default(true)
  nextRunAt         DateTime     @map("next_run_at") @db.Timestamptz(6)
  lockedAt          DateTime?    @map("locked_at") @db.Timestamptz(6)
  failCount         Int          @default(0) @map("fail_count")
  createdAt         DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime     @updatedAt @map("updated_at") @db.Timestamptz(6)

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  runHistories RunHistory[]
  promptVersions PromptVersion[]
  publishedPromptVersion PromptVersion? @relation("PublishedPromptVersion", fields: [publishedPromptVersionId], references: [id], onDelete: SetNull)
  evalSuites    EvalSuite[]

  @@index([nextRunAt], map: "idx_jobs_next_run_at")
  @@index([enabled], map: "idx_jobs_enabled")
  @@index([publishedPromptVersionId], map: "idx_jobs_published_prompt_version_id")
  @@map("jobs")
}

model PromptVersion {
  id        String   @id @default(uuid()) @db.Uuid
  jobId     String   @map("job_id") @db.Uuid
  template  String
  variables Json
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)
  runs RunHistory[]
  publishedBy Job[] @relation("PublishedPromptVersion")
  evalRuns EvalRun[]

  @@index([jobId], map: "idx_prompt_versions_job_id")
  @@map("prompt_versions")
}

model EvalSuite {
  id        String   @id @default(uuid()) @db.Uuid
  jobId     String   @map("job_id") @db.Uuid
  name      String
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  job   Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)
  cases EvalCase[]
  runs  EvalRun[]

  @@index([jobId], map: "idx_eval_suites_job_id")
  @@map("eval_suites")
}

model EvalCase {
  id          String   @id @default(uuid()) @db.Uuid
  suiteId     String   @map("suite_id") @db.Uuid
  variables   Json
  mustInclude Json     @map("must_include")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  suite EvalSuite @relation(fields: [suiteId], references: [id], onDelete: Cascade)

  @@index([suiteId], map: "idx_eval_cases_suite_id")
  @@map("eval_cases")
}

model EvalRun {
  id             String   @id @default(uuid()) @db.Uuid
  suiteId        String   @map("suite_id") @db.Uuid
  promptVersionId String  @map("prompt_version_id") @db.Uuid
  status         String
  results        Json
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  suite EvalSuite     @relation(fields: [suiteId], references: [id], onDelete: Cascade)
  promptVersion PromptVersion @relation(fields: [promptVersionId], references: [id], onDelete: Cascade)

  @@index([suiteId], map: "idx_eval_runs_suite_id")
  @@index([promptVersionId], map: "idx_eval_runs_prompt_version_id")
  @@map("eval_runs")
}

model RunHistory {
  id            String   @id @default(uuid()) @db.Uuid
  jobId         String   @map("job_id") @db.Uuid
  promptVersionId String? @map("prompt_version_id") @db.Uuid
  // The scheduled time this run corresponds to (used for idempotency on cron runs).
  scheduledFor   DateTime? @map("scheduled_for") @db.Timestamptz(6)
  runAt         DateTime @default(now()) @map("run_at") @db.Timestamptz(6)
  status        RunStatus
  // Full output for retrying delivery without re-running the LLM.
  outputText     String?  @map("output_text")
  outputPreview String?  @map("output_preview")
  llmModel      String?  @map("llm_model")
  llmUsage      Json?    @map("llm_usage")
  llmToolCalls  Json?    @map("llm_tool_calls")
  usedWebSearch Boolean  @default(false) @map("used_web_search")
  citations     Json?    @map("citations")
  errorMessage  String?  @map("error_message")
  isPreview     Boolean  @default(false) @map("is_preview")
  // Correlation id for a cron invocation / execution.
  runnerId       String?  @map("runner_id")
  // Delivery receipt summary.
  deliveredAt    DateTime? @map("delivered_at") @db.Timestamptz(6)
  deliveryAttempts Int     @default(0) @map("delivery_attempts")
  deliveryLastError String? @map("delivery_last_error")

  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)
  promptVersion PromptVersion? @relation(fields: [promptVersionId], references: [id], onDelete: SetNull)
  deliveryAttemptsLog DeliveryAttempt[]

  @@index([jobId], map: "idx_run_histories_job_id")
  @@index([promptVersionId], map: "idx_run_histories_prompt_version_id")
  @@unique([jobId, scheduledFor, isPreview], map: "uniq_run_histories_job_scheduled_for_preview")
  @@map("run_histories")
}

model DeliveryAttempt {
  id           String   @id @default(uuid()) @db.Uuid
  runHistoryId String   @map("run_history_id") @db.Uuid
  attempt      Int
  status       String
  statusCode   Int?     @map("status_code")
  errorMessage String?  @map("error_message")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  runHistory RunHistory @relation(fields: [runHistoryId], references: [id], onDelete: Cascade)

  @@index([runHistoryId], map: "idx_delivery_attempts_run_history_id")
  @@unique([runHistoryId, attempt], map: "uniq_delivery_attempts_run_history_attempt")
  @@map("delivery_attempts")
}

model PreviewEvent {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt], map: "idx_preview_events_user_id_created_at")
  @@map("preview_events")
}

model PromptWriterTemplate {
  id               String   @id @default(uuid()) @db.Uuid
  key              String   @unique @db.VarChar(64)
  name             String
  description      String?
  template         String
  defaultVariables Json?    @map("default_variables")
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@map("prompt_writer_templates")
}
